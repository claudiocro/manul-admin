{"version":3,"sources":["../src/create_methods.js"],"names":["context","config","Meteor","ValidatedMethod","SimpleSchema","require","default","error","Error","extendSimpleSchema","schema","otherSchema","version","extend","isAllowed","createFor","collectionName","collections","collection","allowInsertWithId","update","name","validate","simpleSchema","_id","type","String","validator","clean","run","doc","userId","updated","$set","create","optional","insert","destroy","remove","export","isServer","isEmptyObject","field","removeEmptyObjects","data","find","map","keysSet","Set","forEach","entry","add","key","keys","values","methods","Object"],"mappings":"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","file":"create_methods.js","sourcesContent":["\n\nimport flatten from 'flat';\nimport _ from 'lodash';\nimport IsAllowed from './is_allowed';\n\n\nexport default (context, config) => {\n  const { Meteor, ValidatedMethod } = context;\n  let SimpleSchema;\n  try {\n    /* eslint global-require: 0 */\n    SimpleSchema = require('simpl-schema').default;\n  } catch (error) {\n    // try to get from context\n    SimpleSchema = context.SimpleSchema;\n  }\n  if (!SimpleSchema) {\n    throw new Error('please provide SimpleSchema by npm or in context (version 1)');\n  }\n  const extendSimpleSchema = (schema, otherSchema) => {\n    if (SimpleSchema.version === 2) {\n      return schema.extend(otherSchema);\n    }\n    return new SimpleSchema([schema, otherSchema]);\n  };\n  const isAllowed = IsAllowed(config);\n  const createFor = (collectionName) => {\n    const { collection, allowInsertWithId } = config.collections[collectionName];\n    return {\n      update: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.update`,\n        validate: extendSimpleSchema(\n          collection.simpleSchema(), { _id: { type: String } },\n        )\n        .validator({ clean: true }),\n        run({ _id, ...doc }) {\n          // console.log('updating', collectionName, _id, doc);\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n\n          const updated = collection.update(_id, { $set: doc });\n          if (updated === 0) {\n            throw new Meteor.Error('not found', 'Entry not found');\n          }\n        },\n      }),\n      create: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.create`,\n        validate: (allowInsertWithId ?\n          extendSimpleSchema(collection.simpleSchema(), { _id: { type: String, optional: true } }) :\n          collection.simpleSchema()\n        ).validator({ clean: true }),\n        run(doc) {\n          // console.log('inserting', doc);\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          return collection.insert(doc);\n        },\n      }),\n      destroy: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.destroy`,\n        validate: new SimpleSchema(\n          { _id: { type: String } },\n        ).validator({ clean: true }),\n        run({ _id }) {\n          // console.log('inserting', doc);\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          return collection.remove(_id);\n        },\n      }),\n      export: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.export`,\n        validate() {},\n        run() {\n          if (Meteor.isServer) {\n            // TODO: allow filtering and sorting\n            if (!isAllowed(collectionName, this.userId)) {\n              throw new Meteor.Error('not allowed', 'You are not allowed');\n            }\n\n            // empty objects like {} are preserved by flat, but we like to have them empty (null)\n            const isEmptyObject = (\n              field => _.isObject(field) && !_.isDate(field) && _.isEmpty(field)\n            );\n            const removeEmptyObjects = doc => _.omitBy(doc, isEmptyObject);\n\n            // TODO: use schema to define keys\n\n            const data = collection.find().map(flatten).map(removeEmptyObjects);\n            const keysSet = new Set();\n            data.forEach(entry => _.keys(entry).forEach(key => keysSet.add(key)));\n            return {\n              data, keys: [...keysSet.values()],\n            };\n          }\n          return null;\n        },\n      }),\n\n    };\n  };\n\n  const methods = {\n  };\n  Object.keys(config.collections).forEach((collectionName) => {\n    methods[collectionName] = createFor(collectionName);\n  });\n  return methods;\n};\n"]}